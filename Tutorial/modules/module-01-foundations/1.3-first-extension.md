# 1.3 Your First Extension

## Introduction

In this lesson, you'll build your first VS Code extension from scratch. We'll walk through every file, understand the project structure, and create a working extension with multiple features.

## Scaffolding with Yeoman

### Generate a New Extension

Open your terminal and run:

```bash
cd ~/vscode-extensions
yo code
```

### Answer the Prompts

```
? What type of extension do you want to create?
  â¯ New Extension (TypeScript)
? What's the name of your extension?
  â¯ my-first-extension
? What's the identifier of your extension?
  â¯ my-first-extension
? What's the description of your extension?
  â¯ My first VS Code extension
? Initialize a git repository?
  â¯ Yes
? Bundle the source code with webpack?
  â¯ No
? Which package manager to use?
  â¯ npm
```

The generator creates a complete extension project structure.

## Project Structure Walkthrough

Let's explore each file and directory:

```
my-first-extension/
â”œâ”€â”€ .vscode/
â”‚   â”œâ”€â”€ extensions.json      # Recommended extensions
â”‚   â”œâ”€â”€ launch.json          # Debug configuration
â”‚   â”œâ”€â”€ settings.json        # Workspace settings
â”‚   â””â”€â”€ tasks.json           # Build tasks
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ extension.ts         # Main extension code
â”‚   â””â”€â”€ test/
â”‚       â”œâ”€â”€ extension.test.ts # Extension tests
â”‚       â””â”€â”€ index.ts         # Test runner
â”œâ”€â”€ .gitignore               # Git ignore rules
â”œâ”€â”€ .vscodeignore            # Files to exclude from package
â”œâ”€â”€ CHANGELOG.md             # Version history
â”œâ”€â”€ package.json             # Extension manifest
â”œâ”€â”€ README.md                # Extension documentation
â””â”€â”€ tsconfig.json            # TypeScript configuration
```

### 1. `package.json` - The Extension Manifest

This is the most important file. It defines your extension's metadata and capabilities.

```json
{
  "name": "my-first-extension",
  "displayName": "my-first-extension",
  "description": "My first VS Code extension",
  "version": "0.0.1",
  "engines": {
    "vscode": "^1.85.0"
  },
  "categories": [
    "Other"
  ],
  "activationEvents": [],
  "main": "./out/extension.js",
  "contributes": {
    "commands": [
      {
        "command": "my-first-extension.helloWorld",
        "title": "Hello World"
      }
    ]
  },
  "scripts": {
    "vscode:prepublish": "npm run compile",
    "compile": "tsc -p ./",
    "watch": "tsc -watch -p ./",
    "pretest": "npm run compile && npm run lint",
    "lint": "eslint src --ext ts",
    "test": "vscode-test"
  },
  "devDependencies": {
    "@types/vscode": "^1.85.0",
    "@types/mocha": "^10.0.6",
    "@types/node": "18.x",
    "eslint": "^8.54.0",
    "typescript": "^5.3.2",
    "@vscode/test-cli": "^0.0.4",
    "@vscode/test-electron": "^2.3.8"
  }
}
```

**Key Properties**:
- `name`: Extension identifier (lowercase, no spaces)
- `displayName`: Human-readable name
- `version`: Semantic version (major.minor.patch)
- `engines.vscode`: Minimum VS Code version required
- `activationEvents`: When to activate the extension
- `main`: Entry point JavaScript file
- `contributes`: Extension contributions (commands, menus, etc.)

### 2. `src/extension.ts` - The Entry Point

This is where your extension code lives:

```typescript
// The module 'vscode' contains the VS Code extensibility API
import * as vscode from 'vscode';

// This method is called when your extension is activated
export function activate(context: vscode.ExtensionContext) {
    console.log('Congratulations, your extension "my-first-extension" is now active!');

    // Register a command
    let disposable = vscode.commands.registerCommand('my-first-extension.helloWorld', () => {
        vscode.window.showInformationMessage('Hello World from my-first-extension!');
    });

    // Add to subscriptions for proper cleanup
    context.subscriptions.push(disposable);
}

// This method is called when your extension is deactivated
export function deactivate() {}
```

**Key Functions**:
- `activate()`: Called when the extension is activated
- `deactivate()`: Called when the extension is deactivated (cleanup)
- `context.subscriptions`: Array to track disposables for cleanup

### 3. `.vscode/launch.json` - Debug Configuration

Defines how to run and debug your extension:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Run Extension",
      "type": "extensionHost",
      "request": "launch",
      "args": [
        "--extensionDevelopmentPath=${workspaceFolder}"
      ],
      "outFiles": [
        "${workspaceFolder}/out/**/*.js"
      ],
      "preLaunchTask": "${defaultBuildTask}"
    },
    {
      "name": "Extension Tests",
      "type": "extensionHost",
      "request": "launch",
      "args": [
        "--extensionDevelopmentPath=${workspaceFolder}",
        "--extensionTestsPath=${workspaceFolder}/out/test/index"
      ],
      "outFiles": [
        "${workspaceFolder}/out/test/**/*.js"
      ],
      "preLaunchTask": "${defaultBuildTask}"
    }
  ]
}
```

### 4. `tsconfig.json` - TypeScript Configuration

```json
{
  "compilerOptions": {
    "module": "Node16",
    "target": "ES2022",
    "outDir": "out",
    "lib": [
      "ES2022"
    ],
    "sourceMap": true,
    "rootDir": "src",
    "strict": true
  }
}
```

## Running Your Extension

### Step 1: Compile TypeScript

```bash
cd my-first-extension
npm run compile
```

This compiles TypeScript files from `src/` to JavaScript in `out/`.

### Step 2: Start Debugging

1. Open the project in VS Code
2. Press `F5` (or **Run** â†’ **Start Debugging**)
3. A new **Extension Development Host** window opens

### Step 3: Test the Command

In the Extension Development Host:

1. Press `Ctrl+Shift+P` to open Command Palette
2. Type "Hello World"
3. Select "Hello World" command
4. See the notification: "Hello World from my-first-extension!"

### Step 4: Make Changes

Let's modify the extension:

**src/extension.ts**:
```typescript
import * as vscode from 'vscode';

export function activate(context: vscode.ExtensionContext) {
    console.log('Extension activated!');

    // Command 1: Hello World
    let helloWorld = vscode.commands.registerCommand('my-first-extension.helloWorld', () => {
        vscode.window.showInformationMessage('Hello World! ðŸ‘‹');
    });

    // Command 2: Show Date/Time
    let showTime = vscode.commands.registerCommand('my-first-extension.showTime', () => {
        const now = new Date().toLocaleString();
        vscode.window.showInformationMessage(`Current time: ${now}`);
    });

    // Command 3: Show Input Box
    let askName = vscode.commands.registerCommand('my-first-extension.askName', async () => {
        const name = await vscode.window.showInputBox({
            prompt: 'What is your name?',
            placeHolder: 'Enter your name'
        });

        if (name) {
            vscode.window.showInformationMessage(`Hello, ${name}! ðŸŽ‰`);
        }
    });

    context.subscriptions.push(helloWorld, showTime, askName);
}

export function deactivate() {}
```

### Step 5: Update package.json

Add the new commands to the manifest:

```json
{
  "contributes": {
    "commands": [
      {
        "command": "my-first-extension.helloWorld",
        "title": "Hello World"
      },
      {
        "command": "my-first-extension.showTime",
        "title": "Show Current Time"
      },
      {
        "command": "my-first-extension.askName",
        "title": "Ask for Name"
      }
    ]
  }
}
```

### Step 6: Reload Extension

1. In the Extension Development Host, press `Ctrl+Shift+P`
2. Type "Developer: Reload Window"
3. Or press `Ctrl+Shift+F5` in the main window to restart debugging

### Step 7: Test New Commands

Try all three commands:
- "Hello World" - Shows greeting
- "Show Current Time" - Displays date/time
- "Ask for Name" - Prompts for input and greets you

## Understanding Activation Events

Currently, the extension has no `activationEvents` defined, which means it uses `*` (activates on startup).

Let's make it more efficient by activating only when needed:

**package.json**:
```json
{
  "activationEvents": [
    "onCommand:my-first-extension.helloWorld",
    "onCommand:my-first-extension.showTime",
    "onCommand:my-first-extension.askName"
  ]
}
```

Now the extension only loads when one of its commands is invoked.

## Understanding the Extension Context

The `context` parameter in `activate()` provides important information:

```typescript
export function activate(context: vscode.ExtensionContext) {
    // Extension storage path
    console.log('Storage path:', context.storageUri?.fsPath);

    // Global storage path
    console.log('Global storage:', context.globalStorageUri.fsPath);

    // Extension path
    console.log('Extension path:', context.extensionUri.fsPath);

    // Extension version
    console.log('Version:', context.extension.packageJSON.version);

    // Subscriptions for cleanup
    context.subscriptions.push(/* disposables */);
}
```

## Adding Status Bar Item

Let's add a status bar item that shows a message:

```typescript
import * as vscode from 'vscode';

export function activate(context: vscode.ExtensionContext) {
    // Create status bar item
    const statusBarItem = vscode.window.createStatusBarItem(
        vscode.StatusBarAlignment.Right,
        100
    );

    statusBarItem.text = '$(heart) My Extension';
    statusBarItem.tooltip = 'Click to say hello';
    statusBarItem.command = 'my-first-extension.helloWorld';
    statusBarItem.show();

    context.subscriptions.push(statusBarItem);

    // ... rest of your commands
}
```

Icons use [Octicons](https://code.visualstudio.com/api/references/icons-in-labels) with `$(icon-name)` syntax.

## Debugging Tips

### View Debug Output

1. **Debug Console** (`Ctrl+Shift+Y`): See console.log output
2. **Output Panel** (`Ctrl+Shift+U`): Select "Extension Host" or your extension name
3. **Developer Tools** (`Help` â†’ `Toggle Developer Tools`): Full Chrome DevTools

### Set Breakpoints

1. Click in the gutter next to line numbers in `extension.ts`
2. Red dot appears
3. Press `F5` to start debugging
4. Run the command to trigger breakpoint
5. Use `F10` (Step Over), `F11` (Step Into), `Shift+F11` (Step Out)

### Watch Variables

In the Debug view (`Ctrl+Shift+D`):
- **Variables**: View current scope variables
- **Watch**: Add expressions to watch
- **Call Stack**: See function call hierarchy

## Common Issues and Solutions

### Issue: Command not found

**Problem**: Command doesn't appear in Command Palette

**Solutions**:
1. Check `package.json` has command in `contributes.commands`
2. Reload the Extension Development Host window
3. Check for TypeScript compilation errors
4. Verify the command identifier matches exactly

### Issue: Extension not activating

**Problem**: Extension code doesn't run

**Solutions**:
1. Check `activationEvents` in `package.json`
2. Look for errors in Debug Console
3. Verify `main` points to correct output file
4. Ensure `npm run compile` succeeded

### Issue: Changes not reflected

**Problem**: Code changes don't appear

**Solutions**:
1. Run `npm run compile` or use `npm run watch`
2. Reload Extension Development Host (`Ctrl+R`)
3. Restart debugging (`Ctrl+Shift+F5`)

## Best Practices

### 1. Use Disposables Properly

```typescript
const disposable = vscode.commands.registerCommand('cmd', () => {});
context.subscriptions.push(disposable);  // âœ… Proper cleanup

// Not this:
vscode.commands.registerCommand('cmd', () => {});  // âŒ Memory leak
```

### 2. Handle Errors Gracefully

```typescript
vscode.commands.registerCommand('cmd', async () => {
    try {
        // Your code
    } catch (error) {
        vscode.window.showErrorMessage(`Error: ${error}`);
    }
});
```

### 3. Use Async/Await

```typescript
// âœ… Modern async/await
const result = await vscode.window.showInputBox();

// âŒ Callbacks (harder to read)
vscode.window.showInputBox().then(result => {});
```

### 4. Log Useful Information

```typescript
console.log('[MyExtension] Command executed');
console.error('[MyExtension] Error:', error);
```

## Summary

You've learned:

- âœ… How to generate an extension with Yeoman
- âœ… Understanding the project structure
- âœ… The role of package.json (manifest)
- âœ… Writing extension code in TypeScript
- âœ… Registering and handling commands
- âœ… Running and debugging extensions
- âœ… Using the Extension Context
- âœ… Adding status bar items
- âœ… Debugging techniques and troubleshooting

## Exercise

Create an extension that:
1. Has a command "Show File Info" that displays:
   - Active file name
   - Line count
   - File size
   - Language ID
2. Has a status bar item showing the current line count
3. Updates the status bar when the active editor changes

Hint: Use `vscode.window.activeTextEditor` and `vscode.workspace.onDidChangeTextDocument`.

## Next Steps

Continue to [1.4 Extension Manifest Deep Dive](./1.4-manifest-deep-dive.md) to master the package.json file.

## Additional Resources

- [Your First Extension Guide](https://code.visualstudio.com/api/get-started/your-first-extension)
- [Extension Anatomy](https://code.visualstudio.com/api/get-started/extension-anatomy)
- [VS Code API Reference](https://code.visualstudio.com/api/references/vscode-api)
