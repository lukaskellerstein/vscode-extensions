# 3.1 Webviews

## Introduction

Webviews are fully customizable views that render HTML, CSS, and JavaScript inside VS Code. They enable you to create rich, interactive UIs beyond what the standard VS Code API provides. Think dashboards, previews, visualizations, and custom forms.

## What Are Webviews?

Webviews are:
- **HTML-based panels** that run in isolated contexts
- **Highly customizable** with full web technologies
- **Bidirectionally communicative** with your extension
- **Sandboxed** for security
- **Persistent or temporary** based on your needs

## Creating a Basic Webview

### Simple Webview Panel

```typescript
import * as vscode from 'vscode';

export function activate(context: vscode.ExtensionContext) {
    const command = vscode.commands.registerCommand(
        'myExtension.openWebview',
        () => {
            // Create webview panel
            const panel = vscode.window.createWebviewPanel(
                'myWebview',                // View type
                'My Webview',               // Title
                vscode.ViewColumn.One,      // Column to show in
                {}                          // Options
            );

            // Set HTML content
            panel.webview.html = getWebviewContent();
        }
    );

    context.subscriptions.push(command);
}

function getWebviewContent(): string {
    return `<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>My Webview</title>
        <style>
            body {
                padding: 20px;
                color: var(--vscode-foreground);
                background-color: var(--vscode-editor-background);
                font-family: var(--vscode-font-family);
            }
            h1 {
                color: var(--vscode-editor-foreground);
            }
        </style>
    </head>
    <body>
        <h1>Hello from Webview!</h1>
        <p>This is a simple webview example.</p>
    </body>
    </html>`;
}
```

### Webview Options

```typescript
const panel = vscode.window.createWebviewPanel(
    'myWebview',
    'My Webview',
    vscode.ViewColumn.One,
    {
        // Enable scripts in the webview
        enableScripts: true,

        // Restrict resources to specific schemes
        localResourceRoots: [
            vscode.Uri.joinPath(context.extensionUri, 'media'),
            vscode.Uri.joinPath(context.extensionUri, 'dist')
        ],

        // Retain context when hidden
        retainContextWhenHidden: true,

        // Enable finding in webview
        enableFindWidget: true,

        // Enable command URIs
        enableCommandUris: true
    }
);
```

## Loading Resources

### Local Resources

```typescript
function getWebviewContent(
    webview: vscode.Webview,
    extensionUri: vscode.Uri
): string {
    // Get URIs for resources
    const styleUri = webview.asWebviewUri(
        vscode.Uri.joinPath(extensionUri, 'media', 'style.css')
    );
    const scriptUri = webview.asWebviewUri(
        vscode.Uri.joinPath(extensionUri, 'media', 'main.js')
    );
    const imageUri = webview.asWebviewUri(
        vscode.Uri.joinPath(extensionUri, 'media', 'logo.png')
    );

    return `<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="${styleUri}" rel="stylesheet">
        <title>My Webview</title>
    </head>
    <body>
        <img src="${imageUri}" alt="Logo">
        <h1>Webview with Resources</h1>
        <script src="${scriptUri}"></script>
    </body>
    </html>`;
}
```

### Content Security Policy (CSP)

```typescript
function getWebviewContent(webview: vscode.Webview): string {
    // Generate nonce for CSP
    const nonce = getNonce();

    return `<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="Content-Security-Policy"
              content="default-src 'none';
                       style-src ${webview.cspSource} 'unsafe-inline';
                       script-src 'nonce-${nonce}';
                       img-src ${webview.cspSource} https:;">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Secure Webview</title>
    </head>
    <body>
        <h1>Secure Content</h1>
        <script nonce="${nonce}">
            console.log('Script with nonce');
        </script>
    </body>
    </html>`;
}

function getNonce(): string {
    let text = '';
    const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    for (let i = 0; i < 32; i++) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
    }
    return text;
}
```

## Message Passing

### Extension to Webview

```typescript
// Extension side
const panel = vscode.window.createWebviewPanel(
    'myWebview',
    'My Webview',
    vscode.ViewColumn.One,
    { enableScripts: true }
);

// Send message to webview
panel.webview.postMessage({
    command: 'update',
    data: { count: 42, message: 'Hello from extension' }
});

// HTML/JavaScript side
const webviewContent = `
<!DOCTYPE html>
<html>
<body>
    <div id="content">Waiting for data...</div>
    <script>
        const vscode = acquireVsCodeApi();

        // Listen for messages from extension
        window.addEventListener('message', event => {
            const message = event.data;

            switch (message.command) {
                case 'update':
                    document.getElementById('content').textContent =
                        \`Count: \${message.data.count}, Message: \${message.data.message}\`;
                    break;
            }
        });
    </script>
</body>
</html>`;
```

### Webview to Extension

```typescript
// Extension side
panel.webview.onDidReceiveMessage(
    message => {
        switch (message.command) {
            case 'alert':
                vscode.window.showInformationMessage(message.text);
                break;
            case 'getData':
                // Process request and send response
                panel.webview.postMessage({
                    command: 'dataResponse',
                    data: fetchData()
                });
                break;
        }
    },
    undefined,
    context.subscriptions
);

// Webview side
const webviewContent = `
<!DOCTYPE html>
<html>
<body>
    <button onclick="sendAlert()">Send Alert</button>
    <button onclick="requestData()">Get Data</button>

    <script>
        const vscode = acquireVsCodeApi();

        function sendAlert() {
            vscode.postMessage({
                command: 'alert',
                text: 'Hello from webview!'
            });
        }

        function requestData() {
            vscode.postMessage({
                command: 'getData'
            });
        }

        window.addEventListener('message', event => {
            const message = event.data;
            if (message.command === 'dataResponse') {
                console.log('Received data:', message.data);
            }
        });
    </script>
</body>
</html>`;
```

## State Management

### Webview State Persistence

```typescript
// Webview side - Save state
const vscode = acquireVsCodeApi();

// Get previous state
const previousState = vscode.getState();

// Update and save state
function updateState(newData: any) {
    const state = vscode.getState() || {};
    const updatedState = { ...state, ...newData };
    vscode.setState(updatedState);
}

// Use state
if (previousState) {
    console.log('Restored state:', previousState);
}
```

### Extension-side State

```typescript
class WebviewManager {
    private panel: vscode.WebviewPanel | undefined;
    private state: any = {};

    public show(context: vscode.ExtensionContext) {
        if (this.panel) {
            this.panel.reveal();
        } else {
            this.panel = vscode.window.createWebviewPanel(
                'myWebview',
                'My Webview',
                vscode.ViewColumn.One,
                {
                    enableScripts: true,
                    retainContextWhenHidden: true
                }
            );

            this.panel.webview.html = this.getHtmlContent();

            // Restore state when webview is created
            this.panel.webview.postMessage({
                command: 'restoreState',
                state: this.state
            });

            // Handle disposal
            this.panel.onDidDispose(() => {
                this.panel = undefined;
            }, null, context.subscriptions);

            // Handle messages
            this.panel.webview.onDidReceiveMessage(
                message => {
                    if (message.command === 'updateState') {
                        this.state = message.state;
                    }
                },
                undefined,
                context.subscriptions
            );
        }
    }

    private getHtmlContent(): string {
        return `<!DOCTYPE html>
        <html>
        <body>
            <input type="text" id="input" placeholder="Type something...">
            <script>
                const vscode = acquireVsCodeApi();

                // Restore state on load
                window.addEventListener('message', event => {
                    if (event.data.command === 'restoreState') {
                        document.getElementById('input').value =
                            event.data.state.inputValue || '';
                    }
                });

                // Save state on change
                document.getElementById('input').addEventListener('input', e => {
                    vscode.postMessage({
                        command: 'updateState',
                        state: { inputValue: e.target.value }
                    });
                });
            </script>
        </body>
        </html>`;
    }
}
```

## Advanced Patterns

### Single Webview Instance

```typescript
class SingleWebviewManager {
    private static currentPanel: vscode.WebviewPanel | undefined;

    public static show(context: vscode.ExtensionContext) {
        const column = vscode.window.activeTextEditor?.viewColumn;

        // If already exists, reveal it
        if (SingleWebviewManager.currentPanel) {
            SingleWebviewManager.currentPanel.reveal(column);
            return;
        }

        // Create new panel
        const panel = vscode.window.createWebviewPanel(
            'singleWebview',
            'Single Webview',
            column || vscode.ViewColumn.One,
            { enableScripts: true }
        );

        SingleWebviewManager.currentPanel = panel;
        panel.webview.html = this.getHtmlContent();

        // Reset when disposed
        panel.onDidDispose(
            () => {
                SingleWebviewManager.currentPanel = undefined;
            },
            null,
            context.subscriptions
        );
    }

    private static getHtmlContent(): string {
        return `<!DOCTYPE html>
        <html>
        <body>
            <h1>Single Instance Webview</h1>
            <p>Only one instance exists at a time.</p>
        </body>
        </html>`;
    }
}
```

### Dynamic Content Updates

```typescript
class DynamicWebview {
    private panel: vscode.WebviewPanel;
    private updateInterval: NodeJS.Timeout;

    constructor(context: vscode.ExtensionContext) {
        this.panel = vscode.window.createWebviewPanel(
            'dynamicWebview',
            'Dynamic Content',
            vscode.ViewColumn.One,
            { enableScripts: true }
        );

        this.panel.webview.html = this.getHtmlContent();

        // Update every second
        this.updateInterval = setInterval(() => {
            this.updateContent();
        }, 1000);

        // Cleanup on dispose
        this.panel.onDidDispose(
            () => {
                clearInterval(this.updateInterval);
            },
            null,
            context.subscriptions
        );
    }

    private updateContent() {
        this.panel.webview.postMessage({
            command: 'update',
            timestamp: new Date().toISOString(),
            data: this.fetchLatestData()
        });
    }

    private fetchLatestData(): any {
        return {
            cpu: Math.random() * 100,
            memory: Math.random() * 100,
            disk: Math.random() * 100
        };
    }

    private getHtmlContent(): string {
        return `<!DOCTYPE html>
        <html>
        <head>
            <style>
                .metric { margin: 10px 0; }
                .bar {
                    height: 20px;
                    background: var(--vscode-progressBar-background);
                    border-radius: 3px;
                }
            </style>
        </head>
        <body>
            <h1>System Monitor</h1>
            <div id="timestamp"></div>
            <div class="metric">
                <div>CPU: <span id="cpu">0</span>%</div>
                <div class="bar" style="width: 0%" id="cpu-bar"></div>
            </div>
            <div class="metric">
                <div>Memory: <span id="memory">0</span>%</div>
                <div class="bar" style="width: 0%" id="memory-bar"></div>
            </div>
            <div class="metric">
                <div>Disk: <span id="disk">0</span>%</div>
                <div class="bar" style="width: 0%" id="disk-bar"></div>
            </div>

            <script>
                window.addEventListener('message', event => {
                    const message = event.data;
                    if (message.command === 'update') {
                        document.getElementById('timestamp').textContent = message.timestamp;

                        ['cpu', 'memory', 'disk'].forEach(metric => {
                            const value = Math.round(message.data[metric]);
                            document.getElementById(metric).textContent = value;
                            document.getElementById(metric + '-bar').style.width = value + '%';
                        });
                    }
                });
            </script>
        </body>
        </html>`;
    }
}
```

### Form with Validation

```typescript
class FormWebview {
    constructor(context: vscode.ExtensionContext) {
        const panel = vscode.window.createWebviewPanel(
            'formWebview',
            'Create Item',
            vscode.ViewColumn.One,
            { enableScripts: true }
        );

        panel.webview.html = this.getHtmlContent();

        panel.webview.onDidReceiveMessage(
            async message => {
                switch (message.command) {
                    case 'validate':
                        const errors = this.validateForm(message.data);
                        panel.webview.postMessage({
                            command: 'validationResult',
                            errors
                        });
                        break;

                    case 'submit':
                        const validationErrors = this.validateForm(message.data);
                        if (Object.keys(validationErrors).length === 0) {
                            await this.submitForm(message.data);
                            panel.webview.postMessage({
                                command: 'submitSuccess'
                            });
                        } else {
                            panel.webview.postMessage({
                                command: 'validationResult',
                                errors: validationErrors
                            });
                        }
                        break;
                }
            },
            undefined,
            context.subscriptions
        );
    }

    private validateForm(data: any): Record<string, string> {
        const errors: Record<string, string> = {};

        if (!data.name || data.name.length < 3) {
            errors.name = 'Name must be at least 3 characters';
        }

        if (!data.email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email)) {
            errors.email = 'Invalid email address';
        }

        if (!data.age || data.age < 18 || data.age > 120) {
            errors.age = 'Age must be between 18 and 120';
        }

        return errors;
    }

    private async submitForm(data: any): Promise<void> {
        // Process form data
        console.log('Submitting form:', data);
        vscode.window.showInformationMessage(`Form submitted: ${data.name}`);
    }

    private getHtmlContent(): string {
        return `<!DOCTYPE html>
        <html>
        <head>
            <style>
                body {
                    padding: 20px;
                    font-family: var(--vscode-font-family);
                }
                .form-group {
                    margin-bottom: 15px;
                }
                label {
                    display: block;
                    margin-bottom: 5px;
                }
                input {
                    width: 100%;
                    padding: 5px;
                    background: var(--vscode-input-background);
                    color: var(--vscode-input-foreground);
                    border: 1px solid var(--vscode-input-border);
                }
                .error {
                    color: var(--vscode-errorForeground);
                    font-size: 12px;
                    margin-top: 3px;
                }
                button {
                    background: var(--vscode-button-background);
                    color: var(--vscode-button-foreground);
                    border: none;
                    padding: 8px 16px;
                    cursor: pointer;
                }
                button:hover {
                    background: var(--vscode-button-hoverBackground);
                }
            </style>
        </head>
        <body>
            <h1>Create Item</h1>
            <form id="itemForm">
                <div class="form-group">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name">
                    <div class="error" id="name-error"></div>
                </div>

                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email">
                    <div class="error" id="email-error"></div>
                </div>

                <div class="form-group">
                    <label for="age">Age:</label>
                    <input type="number" id="age" name="age">
                    <div class="error" id="age-error"></div>
                </div>

                <button type="submit">Submit</button>
            </form>

            <script>
                const vscode = acquireVsCodeApi();
                const form = document.getElementById('itemForm');

                // Clear errors
                function clearErrors() {
                    document.querySelectorAll('.error').forEach(el => {
                        el.textContent = '';
                    });
                }

                // Display errors
                function displayErrors(errors) {
                    clearErrors();
                    Object.keys(errors).forEach(field => {
                        const errorEl = document.getElementById(field + '-error');
                        if (errorEl) {
                            errorEl.textContent = errors[field];
                        }
                    });
                }

                // Get form data
                function getFormData() {
                    return {
                        name: document.getElementById('name').value,
                        email: document.getElementById('email').value,
                        age: parseInt(document.getElementById('age').value)
                    };
                }

                // Real-time validation
                form.addEventListener('input', () => {
                    vscode.postMessage({
                        command: 'validate',
                        data: getFormData()
                    });
                });

                // Form submission
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    vscode.postMessage({
                        command: 'submit',
                        data: getFormData()
                    });
                });

                // Handle messages from extension
                window.addEventListener('message', event => {
                    const message = event.data;
                    switch (message.command) {
                        case 'validationResult':
                            displayErrors(message.errors);
                            break;
                        case 'submitSuccess':
                            clearErrors();
                            form.reset();
                            alert('Form submitted successfully!');
                            break;
                    }
                });
            </script>
        </body>
        </html>`;
    }
}
```

## Using Web Frameworks

### React Integration

```typescript
// Build process creates bundled React app in dist/webview

function getWebviewContent(
    webview: vscode.Webview,
    extensionUri: vscode.Uri
): string {
    const scriptUri = webview.asWebviewUri(
        vscode.Uri.joinPath(extensionUri, 'dist', 'webview', 'bundle.js')
    );

    return `<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>React Webview</title>
    </head>
    <body>
        <div id="root"></div>
        <script src="${scriptUri}"></script>
    </body>
    </html>`;
}
```

### Svelte Integration

```typescript
// Similar pattern for Svelte
function getWebviewContent(
    webview: vscode.Webview,
    extensionUri: vscode.Uri
): string {
    const scriptUri = webview.asWebviewUri(
        vscode.Uri.joinPath(extensionUri, 'dist', 'webview', 'bundle.js')
    );
    const styleUri = webview.asWebviewUri(
        vscode.Uri.joinPath(extensionUri, 'dist', 'webview', 'bundle.css')
    );

    return `<!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <link href="${styleUri}" rel="stylesheet">
        <title>Svelte Webview</title>
    </head>
    <body>
        <script src="${scriptUri}"></script>
    </body>
    </html>`;
}
```

## Best Practices

### 1. Use Content Security Policy

```typescript
// ✅ Good: Strict CSP
const csp = `default-src 'none';
             style-src ${webview.cspSource} 'unsafe-inline';
             script-src 'nonce-${nonce}';`;

// ❌ Bad: Permissive CSP
const csp = `default-src *;`;
```

### 2. Dispose Properly

```typescript
// ✅ Good: Clean disposal
const panel = vscode.window.createWebviewPanel(...);
panel.onDidDispose(
    () => {
        // Cleanup resources
        clearInterval(updateTimer);
        disposeSubscriptions();
    },
    null,
    context.subscriptions
);

// ❌ Bad: No cleanup
const panel = vscode.window.createWebviewPanel(...);
```

### 3. Handle Visibility Changes

```typescript
panel.onDidChangeViewState(
    e => {
        const panel = e.webviewPanel;
        if (panel.visible) {
            // Resume updates
            startPolling();
        } else {
            // Pause updates
            stopPolling();
        }
    },
    null,
    context.subscriptions
);
```

### 4. Validate Message Data

```typescript
// ✅ Good: Validate messages
panel.webview.onDidReceiveMessage(
    message => {
        if (!message.command || typeof message.command !== 'string') {
            return;
        }

        switch (message.command) {
            case 'update':
                if (message.data && typeof message.data === 'object') {
                    processUpdate(message.data);
                }
                break;
        }
    }
);

// ❌ Bad: Trust all input
panel.webview.onDidReceiveMessage(message => {
    processUpdate(message.data); // No validation
});
```

### 5. Use retainContextWhenHidden Sparingly

```typescript
// Only when necessary (memory intensive)
const panel = vscode.window.createWebviewPanel(
    'myWebview',
    'Title',
    vscode.ViewColumn.One,
    {
        enableScripts: true,
        retainContextWhenHidden: true  // Use only if needed
    }
);
```

## Summary

You've learned:

- ✅ Creating webview panels
- ✅ Loading resources securely
- ✅ Bidirectional messaging
- ✅ State persistence
- ✅ Advanced patterns (single instance, dynamic updates, forms)
- ✅ Web framework integration
- ✅ Security best practices

## Exercise

Create a "Task Manager" webview with:
1. Display list of tasks
2. Add new tasks via form
3. Mark tasks as complete/incomplete
4. Delete tasks
5. Persist state when hidden
6. Real-time validation
7. Use VS Code CSS variables for theming

## Next Steps

Continue to [3.2 Custom Editors](./3.2-custom-editors.md) to learn about building custom file editors.

## Additional Resources

- [Webview API](https://code.visualstudio.com/api/extension-guides/webview)
- [Webview Sample](https://github.com/microsoft/vscode-extension-samples/tree/main/webview-sample)
- [Content Security Policy](https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP)
